// This is an autogenerated file from Firebase Studio.
import { db } from '@/lib/firebase';
import type { CustomMeal } from '@/lib/types';
import { collection, getDocs, addDoc } from 'firebase/firestore';

function getMealCollection(userId: string) {
    if (!userId) throw new Error("User ID is required.");
    return collection(db, 'users', userId, 'customMeals');
}


export async function getCustomMeals(userId: string): Promise<CustomMeal[]> {
    const mealCollection = getMealCollection(userId);
    const snapshot = await getDocs(mealCollection);
    return snapshot.docs.map(doc => {
        const data = doc.data();
        // Ensure default values for optional fields to prevent serialization issues.
        const meal: CustomMeal = {
            id: doc.id,
            name: data.name,
            items: data.items || [],
            totalCalories: data.totalCalories || 0,
            totalProtein: data.totalProtein || 0,
            totalCarbs: data.totalCarbs || 0,
            totalFats: data.totalFats || 0,
            servingSize: data.servingSize || 1,
            servingUnit: data.servingUnit || 'serving',
        };
        return meal;
    });
}

export async function addCustomMeal(userId: string, meal: Omit<CustomMeal, 'id'>): Promise<CustomMeal> {
    const mealCollection = getMealCollection(userId);
    try {
        // Sanitize the object to ensure it's Firestore-compatible
        const cleanMeal = JSON.parse(JSON.stringify(meal));
        const docRef = await addDoc(mealCollection, cleanMeal);
        return { id: docRef.id, ...cleanMeal };
    } catch (error) {
        console.error("Error adding document to Firestore: ", error);
        // Re-throw the error to be caught by the calling function
        if (error instanceof Error) {
            throw new Error(`Firestore error: ${error.message}`);
        }
        throw new Error('An unknown error occurred while saving to Firestore.');
    }
}
